---
title: "Project 1 - Analysis of American Bar Association data"
author: "Eric Chen, Junhan Li, & Daniel Fredin"
output: pdf_document
---

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(splitstackshape)
library(readr)
library(car)
library(lmtest)
library(rcompanion)
library(olsrr)
library(maps)
library(usmap)
library(cowplot)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Load datasets
attorneys <- read.csv("attorneys.csv")
attorneys_time <- read.csv("attorneytimeentries.csv")
categories <- read.csv("categories.csv")
clients <- read.csv("clients.csv")
questionposts <- read.csv("questionposts.csv")
questions <- read.csv("questions.csv")
statesites <- read.csv("statesites.csv")
subcategories <- read.csv("subcategories.csv")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
## DATA CLEANING
# Remove unwanted columns for all datasets
attorneys <- attorneys %>%
  select(-Id, -CreatedUtc, -City, -PostalCode)
attorneys_time <- attorneys_time %>%
  select(-Id, -EnteredOnUtc, -TimeEntryUno)
categories <- categories %>%
  select(-Id)
clients <- clients %>%
  select(-Id, -PostalCode, -CreatedUtc, -InvestmentsBalance)
questionposts <- questionposts %>%
  select(-Id, -CreatedUtc)
questions <- questions %>%
  select(-Id, -AskedOnUtc, -TakenOnUtc, -ClosedOnUtc, -LegalDeadline, -ClosedByAttorneyUno)
statesites <- statesites %>%
  select(-Id)
subcategories <- subcategories %>%
  select(-Id)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Convert characters to numeric in client dataset
clients$Age <- as.integer(clients$Age)
clients$NumberInHousehold <- as.integer(clients$NumberInHousehold)
clients$AnnualIncome <- as.numeric(clients$AnnualIncome)
clients$AllowedIncome <- as.numeric(clients$AllowedIncome)
clients$CheckingBalance <- as.numeric(clients$CheckingBalance)
clients$SavingsBalance <- as.numeric(clients$SavingsBalance)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# rename columns to match other datasets
questions <- questions %>%
  rename("ClientUno" = "AskedByClientUno", "AttorneyUno" = "TakenByAttorneyUno")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Merge into two dataframes
# df1 is all datasets except attorney and attorney_time
df1 <- left_join(clients, questions, join_by("StateAbbr", "ClientUno")) %>% 
  left_join(., categories, join_by("StateAbbr", "CategoryUno", "Category")) %>%
  left_join(.,subcategories, join_by("StateAbbr", "CategoryUno", "Subcategory", "SubcategoryUno")) %>%
  left_join(., questionposts, join_by("StateAbbr", "QuestionUno")) %>%
  left_join(., statesites, join_by("StateAbbr", "StateName"))
# df2 is the two attorney datasets
df2 <- left_join(attorneys, attorneys_time, join_by("StateAbbr", "AttorneyUno")) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Select the independent variables we want to observe and Remove all NA
data_overall <- df1 %>%
  select(StateAbbr, Age, NumberInHousehold, MaritalStatus, AnnualIncome, SavingsBalance, CheckingBalance, AllowedIncome, Category, Subcategory, ClientUno) %>%
  distinct(ClientUno, .keep_all = TRUE) %>%
  select(-ClientUno) %>%
  na.omit(df1)
# Remove all NUll from the MaritalStatus variable 
data_overall <- data_overall %>%  filter(data_overall$MaritalStatus != "NULL")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Change the subcategory to binary categorical data 
# Divorce mentioned entry is represented by 1, otherwise 0. 
data_overall$Subcategory <- ifelse(str_detect(data_overall$Subcategory, "Divorce"), 1, 0)
```


# Visualization 1: Investigating the Top 15 Subcategories of Asked Questions

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 1
top_subcats <- questions %>%
  group_by(Subcategory) %>%
  summarise(num_subcats = n()) %>%
  ungroup()
top_subcats <- top_subcats %>%
  arrange(desc(num_subcats)) %>%
  head(15)
ggplot(top_subcats, aes(x = num_subcats, y = reorder(Subcategory, num_subcats))) +
  geom_segment(aes(xend = 0, yend = Subcategory), color = "#00A19B", linewidth = 3) +
  geom_point(size = 5, color = "#000000", fill=alpha("#00A19B",0.5), alpha = 0.7, shape = 21, stroke = 2) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1), plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top 15 Subcategories",
       x = "Number of Clients",
       y = "Subcategory") +
  theme(axis.title.y = element_text(hjust=0.6))
```

### Interpretation of visualization 1:

Our project aims to begin by exploring the subcategories of legal questions that are frequently asked. This will enable us to identify the most common question type within the dataset we possess and use it as the central topic for our research inquiry. 

According to our horizontal lollipop chart, it is evident that within the top 15 subcategories, two of the highest-ranking categories of inquiries made by clients on the online platform pertain to divorce. The subcategory "Family/Divorce/Custody" holds the highest occurrence among the top 15, with nearly double the number of clients asking questions compared to the second-ranking subcategory, "Other." This highlights the importance of adequately preparing volunteers to handle divorce-related queries.

We find this situation fascinating as it prompts us to seek answers to inquiries like: "What are the key factors influencing divorce?", "Does clients' background influence their inclination to ask divorce-related questions on the ABA online platform?", and, importantly, "How can we adequately train our volunteers to handle these divorce-related inquiries?"
  

# Visualization 2: US Map of Divorce Related Questions Distribution

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ] 
# Changes state variable back to charcter
divorce_plot$state <- as.character(divorce_plot$state)
# Retrieve state populations and rename abbr column to state
states_pop <- statepop
states_pop <- states_pop %>%
  rename("state" = "abbr")

# Plots the distribution of divorces in each state
div_map <- plot_usmap(data = divorce_plot, values = "Freq", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Number of Questions"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Number of divorce related questions")

# Merge the population data with divorce data
dfDivorce <- left_join(states_pop, divorce_plot, join_by("state")) %>%
  select(-fips, -full) %>%
  mutate(distrib = ((Freq/pop_2015)*100000)) %>%
  select(-Freq, -pop_2015)
# Plots the distribution of divorces in each state per population
DF_map <- plot_usmap(data = dfDivorce, values = "distrib", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = 
      "Questions per 100,000 people"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Prevalence of divorce related questions")

plot_grid(div_map, DF_map, ncol = 2, nrow = 1)
```

### Interpretation of visualization 2:

By analyzing the quantity of divorce-related inquiries and their distribution across states, we can gain insights into the clients' backgrounds and identify the regions with the highest occurrence of divorce-related questions.

States like Washington, Oregon, Nevada, Montana, Colorado, North Dakota, Minnesota, Ohio, and Kentucky are depicted in gray on the chart due to legal requirements and confidentiality obligations. These states are prohibited from disclosing clients' information, including the specific category of legal questions they ask.

Among the 42 states that permit the revealing of client details, Texas and Florida demonstrate the greatest volume of inquiries concerning divorce law. Nonetheless, the prevalence of divorce-related questions takes on a distinct pattern when analyzed differently. When considering the number of queries per 100,000 residents, Texas and Florida no longer appear exceptional. Instead, it is Wyoming and Maine that emerge as prominent locations where the rate of individuals frequently seeking online guidance regarding divorce matters are the highest.

# Visualization 3: Financial Status Correlation with Marital Status

```{r eval= TRUE, include=TRUE, echo=FALSE, warning = FALSE, message=FALSE}

# Visualization 3

# Get rid of outliers
quartiles <- quantile(data_overall$AnnualIncome, probs=c(.25, .75), na.rm = FALSE)
IQR <- IQR(data_overall$AnnualIncome)
Lower <- quartiles[1] - 1.5*IQR
Upper <- quartiles[2] + 1.5*IQR

# Investigating the correlation between 
data_noOutlier <- subset(data_overall, AnnualIncome > Lower & AnnualIncome < Upper)

# Create facet titles
Subcategory.labs <- c("Divorce", "Other")
names(Subcategory.labs) <- c("1", "0")

#   Bar charts of median annual income level of people of various marital status
#   Faceted by subcategory 
PlotAnnual <- ggplot(data = data_noOutlier, aes(x = AnnualIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Annual Income",
       y = "Marital Status",
       title = "Client Marital Status and Annual Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median savings balance level of people of various marital status
#   Faceted by subcategory 
PlotSavings <- ggplot(data = data_noOutlier, aes(x = SavingsBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Savings Balance",
       y = "Marital Status",
       title = "Client Marital Status and Savings Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotCheckings <- ggplot(data = data_noOutlier, aes(x = CheckingBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Checking Balance",
       y = "Marital Status",
       title = "Client Marital Status and Checking Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotAllowed <- ggplot(data = data_noOutlier, aes(x = AllowedIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Allowed Income",
       y = "Marital Status",
       title = "Client Marital Status and Allowed Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

plot_grid(PlotAnnual, PlotAllowed, ncol = 1, nrow = 2)
plot_grid(PlotCheckings, PlotSavings, ncol = 1, nrow = 2)
```

### Interpretation of visualization 3:

By analyzing the financial status of clients in relation to their marital status, we can gain insights into whether their likelihood of asking divorce-related questions is influenced by their financial situation and relationship status.

Based on the aforementioned visualization, it becomes apparent that clients seeking divorce-related advice generally have a higher average annual income compared to other clients. However, an exception arises within the married/remarried category, which exhibits even higher annual income than individuals in other marital statuses across both question categories. The states also acknowledge this difference and typically grant higher-income married individuals the opportunity to ask pro bono questions. In other words, the income threshold for asking questions free of charge is noticeably higher for those who are married or remarried in comparison to individuals in other marital statuses. Additionally, it is worth noting that if someone prefers not to disclose their marital status when asking a divorce-related question, their permitted income to inquire without charges decreases.
  
On average, clients seeking divorce-related guidance tend to have lower checking and savings balances compared to clients with different types of inquiries. Among all marital statuses seeking divorce advice, individuals who are divorced possess the highest average checking balance, while those who are widowed have the lowest. This observation is intriguing as both statuses imply that the person does not currently have a partner. Clients with similar statuses, such as single or separated, have checking balances that fall between those of widowed and divorced individuals. However, regardless of the legal advice they seek, single and separated clients generally do not maintain high balances in their savings accounts. In contrast to the data on annual/allowed income, married clients do not exhibit significantly higher checking or savings balances compared to other clients, except for the savings balance of clients seeking non-divorce-related legal advice.


# Research question: Can we derive significant predictive ability by assessing clients' background, including their financial circumstances, relationship status, and state of residence, to determine whether their legal question will be related to divorce?

The objective of this research inquiry is to accurately forecast whether a client will seek legal assistance related to divorce or another area based solely on their background information, encompassing finances, relationship status, and residential location. In this study, we propose that the dependent variable is binary, representing whether the client poses a divorce-related question or not. Meanwhile, the independent or predictor variables encompass the client's age, marital status, state of residence, household size, annual income, as well as checking and savings balances.

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used (in reference to FL and Single)
data_overall$StateAbbr <- relevel(factor(data_overall$StateAbbr), ref = 'FL')
data_overall$MaritalStatus <- relevel(factor(data_overall$MaritalStatus), ref = 'Single')

model1 <- glm(Subcategory ~ StateAbbr + Age + NumberInHousehold
              + MaritalStatus + AnnualIncome + SavingsBalance + CheckingBalance 
              + AllowedIncome - Category, data = data_overall, family = 'binomial')
```

## Assumptions

Given that logistic regression was employed for our research inquiry, we assessed the presence of significant multicollinearity among the predictor variables while making the following assumptions: 

* The dependent variable exhibits two distinct outcomes, namely divorce-related questions or non-divorce-related questions.
* Each observation in the dataset is independent and not a repeated measurement of the same client.
* A linear association exists between each predictor variable and the logit of the dependent variable.
* The dataset comprises a substantial number of samples.
* There are no extreme outliers or influential observations within the dataset.


### Testing for Multicollinearity

During the multicollinearity assessment, it was observed that two of our independent variables, namely NumberInHousehold and AllowedIncome, exhibited a strong correlation. The GVIF values for these variables exceeded 5, indicating the need for their exclusion. This finding aligns with expectations, as the state's permitted income typically depends on the number of dependents residing in a household.

```{r eval= TRUE, include=TRUE, echo=FALSE}
vif(model1)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used 
model1 <- glm(Subcategory ~ . - AllowedIncome - Category, 
              data = data_overall, family = 'binomial')
```

### Fixing Multicollinearity

Upon exclusion of the independent variable "AllowedIncome," we observe a multicollinearity level of less than 5, indicating the absence of multicollinearity within our model.

```{r eval= TRUE, include=TRUE, echo=FALSE}
vif(model1)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 2: Marital Status and Savings Balance influence on divorce related questions
model2 <- glm(Subcategory ~ MaritalStatus + SavingsBalance ,
              data = data_overall, family = 'binomial')
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 3: 
model3 <- glm(Subcategory ~ SavingsBalance + CheckingBalance + 
                MaritalStatus + NumberInHousehold , data = data_overall, 
              family = 'binomial')
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 4:
model4 <- glm(Subcategory ~ AllowedIncome, data = data_overall,
              family = 'binomial')
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 5: Are just the states good predictors?
model5 <- glm(Subcategory ~ StateAbbr, data = data_overall,
              family = 'binomial')
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model comparison
model_comparison <- compareGLM(model1, model2, model3, model4, model5)
```

## Model creation & evaluation


### Comparison of Models

To identify the optimal model, we assessed the Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC) values associated with the five logistic regression models we constructed. 

Based on the principle that model selection criteria strike a balance between goodness of fit and model complexity, it is known that AIC tends to favor more complex models, whereas BIC penalizes complexity more rigorously. Lower values of AIC or BIC indicate a better fit. By examining the chart, we note that the lowest AIC and BIC values correspond to our initial model, which included all the independent variables discussed in our research question.  
Therefore we selected model 1 as it had both the lowest AIC and BIC scores. AIC is a better indicator to use in answering our research question, as it maximizes the predictive power of the data for any future data. However, since both the AIC and BIC values agree on which model out of the five we created is the best, we can safely choose model 1 moving forward.

```{r eval= TRUE, include=TRUE, echo=FALSE}
model_comparison[1]
model_comparison[2]
```

### Summary of best model

With reference to the state of residence of Florida and marital status of Single, we can identify the positive predictor and negative predictor variables to be:

```{r eval= TRUE, include=TRUE, echo=FALSE}
coeff_pos <- model1$coefficients[model1$coefficients >= 0]
coeff_pos
coeff_neg <- model1$coefficients[model1$coefficients < 0]
coeff_neg
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# The predictors that are considered significant at the 5% level of confidence are:
mod_summ <- data.frame(summary(model1)$coef[summary(model1)$coef[,4] <= .05, 4])
print(paste0(row.names(mod_summ)))
```

The summary of our best model is displayed below.

```{r eval= TRUE, include=TRUE, echo=FALSE}
summary(model1)
```

### Odds ratio and confidence intervals for the best model

Using Florida as the reference state and Single as the reference marital status, we can observe some important relationships between the response variable and the associated covariates while holding all other variables constant. For instance

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Using Standard Errors
exp(cbind(OR = coef(model1), confint.default(model1)))
```

### Accuracy of Best Model

Based on the classification table below, our optimal model accurately predicted 37,840 out of 50,620 total observations.

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Accuracy Table
acc_table <- table(factor(data_overall$Subcategory), predict(model1)>0)
acc_table
# % Accuracy
accuracy <- ((acc_table[1] + acc_table[4])/sum(acc_table))*100
print(paste0("The accuracy of our best model was: ", round(accuracy, 2), "%."))
```


#### CA, ID, SC, US, and WI have no divorce-related questions
#### Top shows total questions by state, bottom shows number of divorce-related questions
```{r eval= TRUE, include=TRUE, echo=FALSE}
table(data_noOutlier$StateAbbr)
onlyDivorce <- data_noOutlier %>% filter(Subcategory == 1)
table(onlyDivorce$StateAbbr)
```

# Conclusions

Based on the odds ratios obtained from our top-performing model, it is evident that clients hailing from South Dakota, Maine, and Hawaii exhibit approximately double the likelihood of inquiring about divorce-related matters in comparison to our chosen reference state, Florida. We selected Florida as our reference state due to its significant population, social and economic influence, while having a relatively modest frequency of divorce-related queries. By excluding states without any recorded divorce-related questions, it becomes apparent that Indiana and Nebraska have notably lower rates of such inquiries compared to other states. The odds ratio, slightly exceeding 0.2, indicates that clients from these two states have approximately one-fifth the likelihood of asking a divorce-related question compared to clients from Florida, holding all other variables constant. It is important to note that although numerous states provide client data, many lack sufficient information to draw statistically significant conclusions. However, none of the aforementioned states fall into this category.

Apart from the state of origin, the variables of age, family size, and marital status exhibit significant predictive power in determining whether a client will inquire about divorce-related matters. According to the odds ratio, for each passing year, the likelihood of a client's question being related to divorce decreases by approximately 0.96, holding all other variables constant. All marital statuses, except for "widow," exhibit odds ratios greater than 1, indicating an increased likelihood of divorce-related questions compared to our reference group, "single." Notably, being "separated" raises the odds by nearly a factor of 13, while holding all other variables constant. This aligns with the expectation that clients seeking divorce advice are more likely to be in strained relationships, while being single suggests an absence of a relationship altogether.

In conclusion, the balances of both checking and savings accounts have a strong predictive influence on the category of questions a client may ask. Conversely, we did not observe any predictive capability regarding a client's annual income.

# COMMENTS


WHAT WE NEED TO FINISH:

- Write the summary
  - Suggestion based on limitations , missing data = limitation, states didn't provide data, also some states didn't have Divorce as a subcategory (such as California and the states that are white in viz 2)

FROM PRINCE'S PROJECT EXPECTATIONS:

• Executive summary of your results, your main takeaways and what you
learned completing this project.  
• Findings consistent with literature (if any).  
• Any limitations.  
• Suggestions (usually based on limitations) and/or recommendations.  
   
   

  