---
title: "Project 1 - Analysis of American Bar Association data"
author: "Eric Chen, Junhan Li, & Daniel Fredin"
output: pdf_document
---

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(splitstackshape)
library(readr)
library(car)
library(lmtest)
library(rcompanion)
library(olsrr)
library(maps)
library(usmap)
library(cowplot)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Load datasets
attorneys <- read.csv("attorneys.csv")
attorneys_time <- read.csv("attorneytimeentries.csv")
categories <- read.csv("categories.csv")
clients <- read.csv("clients.csv")
questionposts <- read.csv("questionposts.csv")
questions <- read.csv("questions.csv")
statesites <- read.csv("statesites.csv")
subcategories <- read.csv("subcategories.csv")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
## DATA CLEANING
# Remove unwanted columns for all datasets
attorneys <- attorneys %>%
  select(-Id, -CreatedUtc, -City, -PostalCode)
attorneys_time <- attorneys_time %>%
  select(-Id, -EnteredOnUtc, -TimeEntryUno)
categories <- categories %>%
  select(-Id)
clients <- clients %>%
  select(-Id, -PostalCode, -CreatedUtc, -InvestmentsBalance)
questionposts <- questionposts %>%
  select(-Id, -CreatedUtc)
questions <- questions %>%
  select(-Id, -AskedOnUtc, -TakenOnUtc, -ClosedOnUtc, -LegalDeadline, -ClosedByAttorneyUno)
statesites <- statesites %>%
  select(-Id)
subcategories <- subcategories %>%
  select(-Id)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Convert characters to numeric in client dataset
clients$Age <- as.integer(clients$Age)
clients$NumberInHousehold <- as.integer(clients$NumberInHousehold)
clients$AnnualIncome <- as.numeric(clients$AnnualIncome)
clients$AllowedIncome <- as.numeric(clients$AllowedIncome)
clients$CheckingBalance <- as.numeric(clients$CheckingBalance)
clients$SavingsBalance <- as.numeric(clients$SavingsBalance)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# rename columns to match other datasets
questions <- questions %>%
  rename("ClientUno" = "AskedByClientUno", "AttorneyUno" = "TakenByAttorneyUno")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Merge into two dataframes
# df1 is all datasets except attorney and attorney_time
df1 <- left_join(clients, questions, join_by("StateAbbr", "ClientUno")) %>% 
  left_join(., categories, join_by("StateAbbr", "CategoryUno", "Category")) %>%
  left_join(.,subcategories, join_by("StateAbbr", "CategoryUno", "Subcategory", "SubcategoryUno")) %>%
  left_join(., questionposts, join_by("StateAbbr", "QuestionUno")) %>%
  left_join(., statesites, join_by("StateAbbr", "StateName"))
# df2 is the two attorney datasets
df2 <- left_join(attorneys, attorneys_time, join_by("StateAbbr", "AttorneyUno")) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Select the independent variables we want to observe and Remove all NA
data_overall <- df1 %>%
  select(StateAbbr, Age, NumberInHousehold, MaritalStatus, AnnualIncome, SavingsBalance, CheckingBalance, AllowedIncome, Category, Subcategory, ClientUno, EthnicIdentity, Gender) %>%
  distinct(ClientUno, .keep_all = TRUE) %>%
  select(-ClientUno) %>%
  na.omit(df1)
# Remove all NUll from the MaritalStatus variable 
data_overall <- data_overall %>%  filter(data_overall$MaritalStatus != "NULL")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Change the subcategory to binary categorical data 
# Divorce mentioned entry is represented by 1, otherwise 0. 
data_overall$Subcategory <- ifelse(str_detect(data_overall$Subcategory, "Divorce"), 1, 0)
```


# Visualization 1: Investigating the Top 15 Subcategories of Asked Questions

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 1
top_subcats <- questions %>%
  group_by(Subcategory) %>%
  summarise(num_subcats = n()) %>%
  ungroup()
top_subcats <- top_subcats %>%
  arrange(desc(num_subcats)) %>%
  head(5)
ggplot(top_subcats, aes(x = num_subcats, y = reorder(Subcategory, num_subcats))) +
  geom_segment(aes(xend = 0, yend = Subcategory), color = "#00A19B", linewidth = 3) +
  geom_point(size = 5, color = "#000000", fill=alpha("#00A19B",0.5), alpha = 0.7, shape = 21, stroke = 2) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1), plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top 5 Subcategories",
       x = "Number of Clients",
       y = "Subcategory") +
  theme(axis.title.y = element_text(hjust=0.6))
```

### Interpretation of visualization 1:

Our project aims to begin by exploring the subcategories of legal questions that are frequently asked. This will enable us to identify the most common question type within the dataset we possess and use it as the central topic for our research inquiry. 

According to our horizontal lollipop chart, it is evident that within the top 15 subcategories, two of the highest-ranking categories of inquiries made by clients on the online platform pertain to divorce. The subcategory "Family/Divorce/Custody" holds the highest occurrence among the top 15, with nearly double the number of clients asking questions compared to the second-ranking subcategory, "Other." This highlights the importance of adequately preparing volunteers to handle divorce-related queries.

We find this situation fascinating as it prompts us to seek answers to inquiries like: "What are the key factors influencing divorce?", "Does clients' background influence their inclination to ask divorce-related questions on the ABA online platform?", and, importantly, "How can we adequately train our volunteers to handle these divorce-related inquiries?"
  

# Visualization 2: US Map of Divorce Related Questions Distribution

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ] 
# Changes state variable back to character
divorce_plot$state <- as.character(divorce_plot$state)
# Retrieve state populations and rename abbr column to state
states_pop <- statepop
states_pop <- states_pop %>%
  rename("state" = "abbr")

# Plots the distribution of divorces in each state
div_map <- plot_usmap(data = divorce_plot, values = "Freq", color = "red", labels=TRUE) + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Number of Questions"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Number of divorce related questions")

div_map$layers[[2]]$aes_params$size <- 2

# Merge the population data with divorce data
dfDivorce <- left_join(states_pop, divorce_plot, join_by("state")) %>%
  select(-fips, -full) %>%
  mutate(distrib = ((Freq/pop_2015)*100000)) %>%
  select(-Freq, -pop_2015)
# Plots the distribution of divorces in each state per population
DF_map <- plot_usmap(data = dfDivorce, values = "distrib", color = "red", labels=TRUE) + 
  scale_fill_continuous(
    low = "white", high = "red", name = 
      "Questions per 100,000 people"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Prevalence of divorce related questions")

DF_map$layers[[2]]$aes_params$size <- 2

plot_grid(div_map, DF_map, ncol = 2, nrow = 1)





# Might need to use this if we try to move the overlapping state labels
states <- data.frame(state.abb)
statesLoc <- data.frame(state.center)
usData <- cbind(states, statesLoc)
colnames(usData) <- c("state", "lat", "long")

```

### Interpretation of visualization 2:

By analyzing the quantity of divorce-related inquiries and their distribution across states, we can gain insights into the clients' backgrounds and identify the regions with the highest occurrence of divorce-related questions.

States like Washington, Oregon, Nevada, Montana, Colorado, North Dakota, Minnesota, Ohio, and Kentucky are depicted in gray on the chart due to legal requirements and confidentiality obligations. These states are prohibited from disclosing clients' information, including the specific category of legal questions they ask.

Among the 42 states that permit the revealing of client details, Texas and Florida demonstrate the greatest volume of inquiries concerning divorce law. Nonetheless, the prevalence of divorce-related questions takes on a distinct pattern when analyzed differently. When considering the number of queries per 100,000 residents, Texas and Florida no longer appear exceptional. Instead, it is Wyoming and Maine that emerge as prominent locations where the rate of individuals frequently seeking online guidance regarding divorce matters are the highest.

# Visualization 3: Financial Status Correlation with Marital Status

```{r eval= TRUE, include=TRUE, echo=FALSE, warning = FALSE, message=FALSE}

# Visualization 3

# Get rid of outliers
quartiles <- quantile(data_overall$AnnualIncome, probs=c(.25, .75), na.rm = FALSE)
IQR <- IQR(data_overall$AnnualIncome)
Lower <- quartiles[1] - 1.5*IQR
Upper <- quartiles[2] + 1.5*IQR

# Investigating the correlation between 
data_noOutlier <- subset(data_overall, AnnualIncome > Lower & AnnualIncome < Upper)

# Create facet titles
Subcategory.labs <- c("Divorce", "Other")
names(Subcategory.labs) <- c("1", "0")

#   Bar charts of median annual income level of people of various marital status
#   Faceted by subcategory 
PlotAnnual <- ggplot(data = data_noOutlier, aes(x = AnnualIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Annual Income",
       y = "Marital Status",
       title = "Client Marital Status and Annual Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median savings balance level of people of various marital status
#   Faceted by subcategory 
PlotSavings <- ggplot(data = data_noOutlier, aes(x = SavingsBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Savings Balance",
       y = "Marital Status",
       title = "Client Marital Status and Savings Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotCheckings <- ggplot(data = data_noOutlier, aes(x = CheckingBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Checking Balance",
       y = "Marital Status",
       title = "Client Marital Status and Checking Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotAllowed <- ggplot(data = data_noOutlier, aes(x = AllowedIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Allowed Income",
       y = "Marital Status",
       title = "Client Marital Status and Allowed Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

plot_grid(PlotAnnual, PlotAllowed, ncol = 1, nrow = 2)
plot_grid(PlotCheckings, PlotSavings, ncol = 1, nrow = 2)
```




```{r}
top_status <- data_noOutlier %>%
  group_by(MaritalStatus) %>%
  summarise(num_status = n()) %>%
  ungroup()
numtop_status <- top_status %>%
  arrange(desc(num_status)) %>%
  head(5)
```




###############TESTING VISUALIZATION 3

```{r eval= TRUE, include=TRUE, echo=FALSE, warning = FALSE, message=FALSE}

# Visualization 3

# # Data cleaning, select the top 4 Marital status
# top_status <- data_overall %>%
#   group_by(MaritalStatus) %>%
#   summarise(num_status = n()) %>%
#   ungroup()
# numtop_status <- top_status %>%
#   arrange(desc(num_status)) %>%
#   head(4)







data_Plot3 <- data_overall



# Function removes all outliers 
outliers <- function(x) {

  Q1 <- quantile(x, probs=.25)
  Q3 <- quantile(x, probs=.75)
  iqr = Q3-Q1

 upper_limit = Q3 + (iqr*1.5)
 lower_limit = Q1 - (iqr*1.5)

 x > upper_limit | x < lower_limit
}

remove_outliers <- function(df, cols = names(df)) {
  for (col in cols) {
    df <- df[!outliers(df[[col]]),]
  }
  df
}

data_noOutlier <- remove_outliers(data_overall, c("Age", "AnnualIncome", "SavingsBalance", "CheckingBalance", "AllowedIncome"))

data_Plot3 <- data_noOutlier



# Select top 5 marital status
data_Plot3 <- subset(data_Plot3, MaritalStatus %in% c("Single", "Married / remarried", "Divorced or Widowed", "Separated"))

# Create facet titles
Subcategory.labs <- c("Divorce", "Other")
names(Subcategory.labs) <- c("1", "0")


#   Box plot of median annual income level of people of top 4 marital status
#   Faceted by subcategory 
PlotAnnual <- ggplot(data = data_Plot3, 
                     aes(x = AnnualIncome , 
                         y = MaritalStatus, 
                         fill = MaritalStatus)) +
  geom_boxplot() +
  labs(x = "Annual Income",
       y = "Marital Status",
       title = "Comparing Top 4 Client Marital statuses with Annual Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, 
             labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), 
        legend.position = "none") +
  coord_cartesian(xlim = c(0, 80000))



#   Box plot of median checking balance level of people of top 4 marital status
#   Faceted by subcategory 
PlotAllowed <- ggplot(data = data_Plot3, 
                      aes(x = AllowedIncome , 
                          y = MaritalStatus, 
                          fill = MaritalStatus)) +
  geom_boxplot() +
  labs(x = "Allowed Income",
       y = "Marital Status",
       title = "Comparing Top 4 Client Marital statuses with Allowed Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, 
             labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), 
        legend.position = "none")+
  coord_cartesian(xlim = c(0, 75000))




#   Box plot of median checking balance level of people of top 4 marital status
#   Faceted by subcategory 
PlotCheckings <- ggplot(data = data_Plot3, 
                        aes(x = CheckingBalance , 
                            y = MaritalStatus, 
                            fill = MaritalStatus)) +
  geom_boxplot() +
  labs(x = "Checking Balance",
       y = "Marital Status",
       title = "Comparing Top 4 Client Marital statuses with Checking Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, 
             labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), 
        legend.position = "none") +
  coord_cartesian(xlim = c(-300, 300))


#   Box plot of median savings balance level of people of top 4 marital status
#   Faceted by subcategory 
PlotSavings <- ggplot(data = data_Plot3, 
                      aes(x = SavingsBalance , 
                          y = MaritalStatus, 
                          fill = MaritalStatus)) +
  geom_boxplot() +
  labs(x = "Savings Balance",
       y = "Marital Status",
       title = "Comparing Top 4 Client Marital statuses with Savings Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, 
             labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), 
        legend.position = "none") +
  coord_cartesian(xlim = c(-300, 300))




plot_grid(PlotAnnual, PlotAllowed, ncol = 1, nrow = 2)
plot_grid(PlotCheckings, PlotSavings, ncol = 1, nrow = 2)
```




### Interpretation of visualization 3:

By analyzing the financial status of clients in relation to their marital status, we can gain insights into whether their likelihood of asking divorce-related questions is influenced by their financial situation and relationship status.

Based on the aforementioned visualization, it becomes apparent that clients seeking divorce-related advice generally have a higher average annual income compared to other clients. However, an exception arises within the married/remarried category, which exhibits even higher annual income than individuals in other marital statuses across both question categories. The states also acknowledge this difference and typically grant higher-income married individuals the opportunity to ask pro bono questions. In other words, the income threshold for asking questions free of charge is noticeably higher for those who are married or remarried in comparison to individuals in other marital statuses. Additionally, it is worth noting that if someone prefers not to disclose their marital status when asking a divorce-related question, their permitted income to inquire without charges decreases.
  
On average, clients seeking divorce-related guidance tend to have lower checking and savings balances compared to clients with different types of inquiries. Among all marital statuses seeking divorce advice, individuals who are divorced possess the highest average checking balance, while those who are widowed have the lowest. This observation is intriguing as both statuses imply that the person does not currently have a partner. Clients with similar statuses, such as single or separated, have checking balances that fall between those of widowed and divorced individuals. However, regardless of the legal advice they seek, single and separated clients generally do not maintain high balances in their savings accounts. In contrast to the data on annual/allowed income, married clients do not exhibit significantly higher checking or savings balances compared to other clients, except for the savings balance of clients seeking non-divorce-related legal advice.

# Research question: 

Is there significant predictive ability by assessing clients' background to determine whether their legal question will be related to divorce?

The objective of this research inquiry is to accurately forecast whether a client will seek legal assistance related to divorce or another area based solely on their sociodemographics. In this study, we propose that the dependent variable is binary, representing whether the client poses a divorce-related question or not. 








## Model creation & evaluation


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Find the top 3 states
num_states <- data_overall %>%
  group_by(StateAbbr) %>%
  summarise(nums = n()) %>%
  ungroup()
num_states <- num_states %>%
  arrange(desc(nums)) %>%
  head(3)
#num_states

# Find the top 5 marital status
num_marital <- data_overall %>%
  group_by(MaritalStatus) %>%
  summarise(nums = n()) %>%
  ungroup()
num_marital <- num_marital %>%
  arrange(desc(nums)) %>%
  head(4)
#num_marital

# Find the top 3 ethics
num_ethnic <- data_overall %>%
  group_by(EthnicIdentity) %>%
  summarise(nums = n()) %>%
  ungroup()
num_ethnic <- num_ethnic %>%
  arrange(desc(nums)) %>%
  head(3)
#num_ethnic

# Find the top 2 genders
num_sex <- data_overall %>%
  group_by(Gender) %>%
  summarise(nums = n()) %>%
  ungroup()
num_sex <- num_sex %>%
  arrange(desc(nums)) %>%
  head(2)
#num_sex
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
model_data <- data_overall 

# model_data <- data_overall %>%
#   select(-EthnicIdentity)



# Create refined dataset for input to our models 
# Mutate the top 3 states into 1 variable and all others into another variable

# TOP 3 STATES ARE............FL, TX, IN
model_data <- model_data %>%
  mutate(GroupedStateAbbr = case_when(
    StateAbbr %in% c("FL", "TX", "IN") ~ "Top 3 States",
    TRUE ~ "All Other States"))
  
model_data <- model_data %>%
  mutate(MaritalStatus = case_when(
    MaritalStatus %in% ("Single") ~ "Single",
    MaritalStatus %in% ("Married / remarried") ~ "Married / remarried", 
    MaritalStatus %in% ("Divorced or Widowed") ~ "Divorced or Widowed",
    MaritalStatus %in% ("Separated") ~ "Separated",
    TRUE ~ "All Other Marital Status"))


model_data <- model_data %>%
  mutate(EthnicIdentity = case_when(
    EthnicIdentity %in% ("Caucasian") ~ "Caucasian",
    EthnicIdentity %in% ("African American") ~ "African American",
    EthnicIdentity %in% ("Not Hispanic or Latino") ~ "Not Hispanic or Latino",
    TRUE ~ "All Other Ethnicities"))


model_data <- model_data %>%
  mutate(Gender = case_when(
    Gender %in% ("Female") ~ "Female",
    Gender %in% ("Male") ~ "Male",
    TRUE ~ "All Other Genders"))


# 
# # Select the top 4 marital status
# model_data <- subset(model_data,
#                      MaritalStatus %in% c("Single", "Married / remarried", "Divorced or Widowed", "Separated"))

# # Select the top 3 ethnicities
# model_data <- subset(model_data,
#                      EthnicIdentity %in% c("Caucasian", "African American", "Not Hispanic or Latino"))

# # Select the top 2 genders
# model_data <- subset(model_data,
#                      Gender %in% c("Female", "Male"))

# All independent variables used (in reference to Top 3 States and Single, Caucasian, Male)
model_data$GroupedStateAbbr <- relevel(factor(model_data$GroupedStateAbbr), ref = 'Top 3 States')
model_data$MaritalStatus <- relevel(factor(model_data$MaritalStatus), ref = 'Single')
model_data$EthnicIdentity <- relevel(factor(model_data$EthnicIdentity), ref = 'Caucasian')
model_data$Gender <- relevel(factor(model_data$Gender), ref = 'Male')

# Remove category and stateabbr
model_data <- model_data %>%
  select(-Category, -StateAbbr)

# Remove all NULL values
model_data[model_data == "NULL"] = NA
model_data <- na.omit(model_data)

```




```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used 
model1 <- glm(Subcategory ~ ., data = model_data, family = 'binomial')

```



```{r eval= TRUE, include=FALSE, echo=FALSE}
# # Model 2: Using stepwise variable selection
# model2 <- step(model1, trace=FALSE, direction = "both", k=log(nrow(model_data)))
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 2: Based on significant factors

refined_data <- model_data %>%
  select(-AnnualIncome)

# Select the top 3 ethnicities since not hispanic or latino is not significant
refined_data <- subset(refined_data,
                     EthnicIdentity %in% c("Caucasian", "African American", "All Other Ethnicities"))



model2 <- glm(Subcategory ~ Age + NumberInHousehold + MaritalStatus + SavingsBalance + CheckingBalance + Gender + GroupedStateAbbr + EthnicIdentity, data = refined_data, family = 'binomial')
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# library(glmtoolbox)
# 
# model2test <- stepCriterion(model1, 
#                          direction="forward", 
#                          criterion="aic", 
#                          test="lr",
#                          levels = c(0.01, 0.01),
#                          k = 2.7)
```



```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 3: Based solely upon client financial information
model3 <- glm(Subcategory ~ AnnualIncome + SavingsBalance + CheckingBalance, 
              data = model_data, 
              family = 'binomial')
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model comparison
model_comparison <- compareGLM(model1, model2, model3)
```


### Comparison of Models

To identify the optimal model, we assessed the Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC) values associated with the five logistic regression models we constructed. 

Based on the principle that model selection criteria strike a balance between goodness of fit and model complexity, it is known that AIC tends to favor more complex models, whereas BIC penalizes complexity more rigorously. Lower values of AIC or BIC indicate a better fit. By examining the chart, we note that the lowest AIC and BIC values correspond to our initial model, which included all the independent variables discussed in our research question. Therefore we selected model 1 as it had both the lowest AIC and BIC scores. AIC is a better indicator to use in answering our research question, as it maximizes the predictive power of the data for any future data. However, since both the AIC and BIC values agree on which model out of the five we created is the best, we can safely choose model 1 moving forward.

```{r eval= TRUE, include=FALSE, echo=FALSE}
cat("The 3 models formulae:\n\n")
cat("Model 1: Subcategory ~ Age + NumberInHousehold + MaritalStatus + AnnualIncome + SavingsBalance + CheckingBalance + AllowedIncome + EthnicIdentity + Gender + GroupedStateAbbr\n")
cat("Model 2: Age + NumberInHousehold + MaritalStatus + SavingsBalance + CheckingBalance + Gender + GroupedStateAbbr + EthnicIdentity\n")
cat("Model 3: Subcategory ~ AnnualIncome + SavingsBalance + CheckingBalance\n")
```

```{r eval= TRUE, include=TRUE, echo=FALSE}
model_comparison[2]
```




##################
Logistic Regression for our best model: 
Log odds of asking question related to divorce 
##################


$$
P(Divorce = 1) = \frac{1}{e^{-(\beta_0 + \beta_1(Var1) + \beta_2(Var2)...)}}
$$

$$
logit(P(Divorce = 1)) = \beta_0 + \beta_1(Var1) + \beta_2(Var2)...
$$



## Assumptions

Given that logistic regression was employed for our research inquiry, we assessed the presence of significant multicollinearity among the predictor variables while making the following assumptions: 

* The dependent variable exhibits two distinct outcomes, namely divorce-related questions or non-divorce-related questions.
* Each observation in the dataset is independent and not a repeated measurement of the same client.
* A linear association exists between each predictor variable and the logit of the dependent variable.
* The dataset comprises a substantial number of samples.
* There are no extreme outliers or influential observations within the dataset.

### Testing for Multicollinearity

While conducting the multicollinearity assessment, it was noticed that the GVIF (Generalized Variance Inflation Factor) values for all our predictor variables were below 5. This suggests that we can safely assume the independence of observations in the dataset.

```{r eval= TRUE, include=TRUE, echo=FALSE}
vif(model2)
```















### Summary of best model

```{r}
summary(model2)
```


The predictors deemed statistically significant with a confidence level of 5% are:

```{r eval= TRUE, include=TRUE, echo=FALSE}
# The predictors that are considered significant at the 5% level of confidence are:
mod_summ <- data.frame(summary(model2)$coef[summary(model2)$coef[,4] <= .05, 4])
print(paste0(row.names(mod_summ)))
```

### Odds ratio and confidence intervals for the best model

By considering Florida as the reference state and Single as the reference marital status, we can discern significant associations between the response variable and the corresponding covariates while keeping all other variables constant. 

For example, in comparison to single clients, those who are separated exhibited considerably higher odds (OR = 12.9, 95% CI = 11.9-14.1) of inquiring about divorce-related matters. In terms of percentage change, the likelihood of a separated client posing divorce-related questions is approximately 1190% greater than that of a single client.

The odds ratio (OR) for Age was found to be 0.956 (95% CI = 0.958-0.962). The confidence interval, which does not overlap with 1, indicates a significant variation in the likelihood of clients asking questions about divorce based on their age. Specifically, for each unit increase in a client's age, the odds of them inquiring about divorce decrease by 4.40%.

For Number in Household, the odd ratio is 1.09, with 95% CI being 1.07 and 1.10.  The confidence interval did not cross 1, which means there is a difference between clients with different number of people in household, so it’s significant for our prediction. This means that the odds of client asking question related to divorce will increase by 9% for every unit increases of number of people in client’s household with true population effect between 7% and 10%. 

For Annual Income, the odd ratio is 0.999, with 95% CI being 0.999 and 1.00. The confidence interval crossed 1, which means there is no difference between clients with different annual income so it’s not significant for our prediction. 

For checking balance, the odd ratio is 0.99, with 95% CI being 0.99 and 0.99. The confidence interval did not cross 1, which means there is difference between clients of different checking balance when it comes to the odds of asking questions related to divorce. The influence of checking balance on the odds of clients asking divorce related question is equally weak as that of saving balance.

For state, let’s take Hawaii(StateAbbrHI) as an example, the odds ratio is 2.21 with 95% CI being 1.85 to 2.64. The confidence interval did not cross 1, which means there is difference between clients from Hawaii and  different states when it comes to the odds of asking questions related to divorce.  This means that the odds for clients from the state of Hawaii to ask question related divorce is 2.21 times more likely than the clients from other states, with the true population effect between 1.85 to 2.64.  

On the other hand, the state Georgia(StateAbbrGA), the odds ratio is  0.95 with 95% CI being 0.84 to 1.06. The confidence interval did cross 1, which means there is no difference between clients from Georgia and other different states when it comes to the odds of asking questions related to divorce. 

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Using Standard Errors
exp(cbind(OR = coef(model2), confint.default(model2)))
```

### Accuracy of Best Model

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Accuracy Table
acc_table <- table(factor(refined_data$Subcategory), predict(model2)>0)
acc_table
# % Accuracy
accuracy <- ((acc_table[1] + acc_table[4])/sum(acc_table))*100
cat("\nThe accuracy of our best model was:", round(accuracy, 2), "%.")
```

The accuracy classification table presented indicates that around 72% of the fitted values were accurately classified, as calculated by adding the number of correctly classified values (29730) to the number of false negatives (3118), and dividing it by the total number of observations (45731).

In terms of accuracy, this implies that our model performs significantly better than a random guess. Randomly guessing the correct classification for divorce-related questions would yield a 50% chance of being accurate. However, our model surpasses this baseline, demonstrating a higher level of accuracy.








# Summary & Conclusions

Based on the odds ratios obtained from our top-performing model, it is evident that clients hailing from South Dakota, Maine, and Hawaii exhibit approximately double the likelihood of inquiring about divorce-related matters in comparison to our chosen reference state, Florida. We selected Florida as our reference state due to its significant population, social and economic influence, while having a relatively modest frequency of divorce-related queries. By excluding states without any recorded divorce-related questions, it becomes apparent that Indiana and Nebraska have notably lower rates of such inquiries compared to other states. The odds ratio, slightly exceeding 0.2, indicates that clients from these two states have approximately one-fifth the likelihood of asking a divorce-related question compared to clients from Florida, holding all other variables constant. It is important to note that although numerous states provide client data, many lack sufficient information to draw statistically significant conclusions. However, none of the aforementioned states fall into this category.

Apart from the state of origin, the variables of age, family size, and marital status exhibit significant predictive power in determining whether a client will inquire about divorce-related matters. According to the odds ratio, for each passing year, the likelihood of a client's question being related to divorce decreases by approximately 0.96, holding all other variables constant. All marital statuses, except for "widow," exhibit odds ratios greater than 1, indicating an increased likelihood of divorce-related questions compared to our reference group, "single." Notably, being "separated" raises the odds by nearly a factor of 13, while holding all other variables constant. This aligns with the expectation that clients seeking divorce advice are more likely to be in strained relationships, while being single suggests an absence of a relationship altogether. In conclusion, the balances of both checking and savings accounts have a strong predictive influence on the category of questions a client may ask. Conversely, we did not observe any predictive capability regarding a client's annual income.

The key lesson we learned from this assignment is that statistical computing has the potential to be applied in professional domains for predicting trends and effectively allocating resources. Going beyond the project's requirements and outcomes, we believe the American Bar Association could employ the models we developed to determine the states requiring more divorce lawyers and collaborate with state governments accordingly. While our data was limited to lower-income individuals and pro bono attorneys, we suspect that the trends we identified are indicative of other income brackets and paid attorneys on a broader scale. However, the most significant constraint we faced in exploring our research question was the insufficient data from certain states and the apparent disparity in data availability among other states. 

Another crucial lesson we learned from this project is the significance of establishing a clear objective when dealing with unorganized data. Given the extensive volume of data at our disposal, it becomes even more crucial to formulate specific research questions early on and filter the data accordingly. The majority of datasets contain far more information than what is necessary for drawing significant conclusions. In the dataset obtained from the American Bar Association pro bono service, we discovered that a select few states, precisely ten, lacked the provision of clients' demographic information.  Nevertheless, since we have excluded those states from our dataset, we can confidently affirm that we possess significant predictive power for clients residing in states that did provide client demographics.

We encountered another limitation during our research. We found that the states of California, Idaho, South Carolina, and Wisconsin did not classify the client's legal questions related to divorce into specific subcategories. Instead, they grouped them under broader categories like Family and Children. As a result, we couldn't determine the extent to which clients in those states sought divorce-related information. However, since these states didn't provide any divorce-related data, similar to the previous limitation, we can assert with confidence that our model has significant predictive capability for clients in states where categorical data on divorces was available. Overall, we are confident that our model can accurately predict outcomes with approximately 75% accuracy for around 72% of the United States.

A potential strategy to address the constraints mentioned earlier involves incorporating predictor variables that encompass the entirety of the United States, instead of solely relying on data from particular states. This approach would enable us to accurately predict the client's legal inquiries nationwide, without the need to specify the states for which we possess accurate predictions. Another option could be for the American Bar Association (ABA) to mandate that states provide their data within a nationwide framework, guaranteeing consistent consideration of demographics and legal query categories.

After examining various scientific literature, we were unable to find any studies that reported similar findings related to our research question. However, we did successfully explore different sets of literature concerning the factors that contribute to accurately predicting divorce. This exploration is relevant to our goal of understanding our predictive power in divorce-related legal matters. Specifically, the National Institutes of Health (NIH) published an article discussing the risks of predicting divorce without conducting proper crossvalidation analyses and sensitivity tests. They concluded that "exceptional initial predictive results can assist us in enhancing models by identifying significant risk factors" [1]. This conclusion allows us to better evaluate the accuracy of our predictive model. Although we achieved a 74.75% success rate in predicting divorce-related queries from clients, it is important to conduct thorough crossvalidation and sensitivity testing to avoid overestimating the model's predictive capabilities. Instead, we should focus on the model's ability to identify crucial and meaningful predictors.

[1] Heyman RE, Smith Slep AM. The Hazards of Predicting Divorce Without Crossvalidation. J Marriage Fam. 2001 May;63(2):473-479. doi: 10.1111/j.1741-3737.2001.00473.x. PMID: 17066126; PMCID: PMC1622921.