---
title: "Project 1 - Analysis of American Bar Association data"
author: "Eric Chen, Junhan Li, & Daniel Fredin"
output: pdf_document
---

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(splitstackshape)
library(readr)
library(car)
library(lmtest)
library(rcompanion)
library(olsrr)
library(maps)
library(usmap)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Load datasets
attorneys <- read.csv("attorneys.csv")
attorneys_time <- read.csv("attorneytimeentries.csv")
categories <- read.csv("categories.csv")
clients <- read.csv("clients.csv")
questionposts <- read.csv("questionposts.csv")
questions <- read.csv("questions.csv")
statesites <- read.csv("statesites.csv")
subcategories <- read.csv("subcategories.csv")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
## DATA CLEANING
# Remove unwanted columns for all datasets
attorneys <- attorneys %>%
  select(-Id, -CreatedUtc, -City, -PostalCode)
attorneys_time <- attorneys_time %>%
  select(-Id, -EnteredOnUtc, -TimeEntryUno)
categories <- categories %>%
  select(-Id)
clients <- clients %>%
  select(-Id, -PostalCode, -CreatedUtc, -InvestmentsBalance)
questionposts <- questionposts %>%
  select(-Id, -CreatedUtc)
questions <- questions %>%
  select(-Id, -AskedOnUtc, -TakenOnUtc, -ClosedOnUtc, -LegalDeadline, -ClosedByAttorneyUno)
statesites <- statesites %>%
  select(-Id)
subcategories <- subcategories %>%
  select(-Id)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Convert characters to numeric in client dataset
clients$Age <- as.integer(clients$Age)
clients$NumberInHousehold <- as.integer(clients$NumberInHousehold)
clients$AnnualIncome <- as.numeric(clients$AnnualIncome)
clients$AllowedIncome <- as.numeric(clients$AllowedIncome)
clients$CheckingBalance <- as.numeric(clients$CheckingBalance)
clients$SavingsBalance <- as.numeric(clients$SavingsBalance)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# rename columns to match other datasets
questions <- questions %>%
  rename("ClientUno" = "AskedByClientUno", "AttorneyUno" = "TakenByAttorneyUno")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Merge into two dataframes
# df1 is all datasets except attorney and attorney_time
df1 <- left_join(clients, questions, join_by("StateAbbr", "ClientUno")) %>% 
  left_join(., categories, join_by("StateAbbr", "CategoryUno", "Category")) %>%
  left_join(.,subcategories, join_by("StateAbbr", "CategoryUno", "Subcategory", "SubcategoryUno")) %>%
  left_join(., questionposts, join_by("StateAbbr", "QuestionUno")) %>%
  left_join(., statesites, join_by("StateAbbr", "StateName"))
# df2 is the two attorney datasets
df2 <- left_join(attorneys, attorneys_time, join_by("StateAbbr", "AttorneyUno")) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Select the independent variables we want to observe and Remove all NA
data_overall <- df1 %>%
  select(StateAbbr, Age, NumberInHousehold, MaritalStatus, AnnualIncome, SavingsBalance, CheckingBalance, AllowedIncome, Category, Subcategory, ClientUno) %>%
  distinct(ClientUno, .keep_all = TRUE) %>%
  select(-ClientUno) %>%
  na.omit(df1)
# Remove all NUll from the MaritalStatus variable 
data_overall <- data_overall %>%  filter(data_overall$MaritalStatus != "NULL")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Change the subcategory to binary categorical data 
# Divorce mentioned entry is represented by 1, otherwise 0. 
data_overall$Subcategory <- ifelse(str_detect(data_overall$Subcategory, "Divorce"), 1, 0)
```


# Visualization 1: Investigating the Top 15 Subcategories of Asked Questions

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 1
top_subcats <- questions %>%
  group_by(Subcategory) %>%
  summarise(num_subcats = n()) %>%
  ungroup()
top_subcats <- top_subcats %>%
  arrange(desc(num_subcats)) %>%
  head(15)
ggplot(top_subcats, aes(x = num_subcats, y = reorder(Subcategory, num_subcats))) +
  geom_bar(stat = "Identity", fill = "#00A19B") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Top 15 Subcategories",
       x = "Number of Clients",
       y = "Subcategory")
```
Interpretation:  
  For our project, we want to started off with investigating the most frequently asked legal questions subcategories so we can define a most common question type based on the data set we have at hand and use it as the theme of our research question. 

  Based on our side way bar chart, it is clear to see that out of the top 15 subcategories, among the top three categories of questions asked by clients on the online platform, two of them are related to divorce.The question of subcategory Family/Divorce/Custody has the highest frequency among the top 15, and it has been asked by almost twice as many clients than the second subcategory of others, which is showing that the divorce related questions should be treated with more preparation when it comes to training volunteers.  

  This is intriguing to us as it begs for answers to the questions such as: "What are the major determinants of divorce?","Do the clients' backgrounds affect their tendency to ask divorce related question on the ABA online platform?", and most importantly, "How do we prepare our volunteers to address these divorce related questions?"
  

# Visualization 2: US Map of Divorce Related Questions Distribution

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ]  
# Plots the distribution of divorces in each state
plot_usmap(data = divorce_plot, values = "Freq", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Frequency of Divorce Related Questions"
    , label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "US map plot of distribution of divorce rate")
```
  Certain States such as: Washington, Oregon, Nevada, Montana, Colorado, 
Minnesota, Ohio, and Kentucky are shown in gray because out of confidentiality 
and per state law, they are not allowed to provided clients' information. 

  However, the distribution of the divorce questions frequency does varied by 
states. For example, states such as Texas and Florida has the highest frequency
of divorce related questions discuss with the attorney on the online platform. 


```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ] 
# Changes state variable back to charcter
divorce_plot$state <- as.character(divorce_plot$state)
# Retrieve state populations and rename abbr column to state
states_pop <- statepop
states_pop <- states_pop %>%
  rename("state" = "abbr")
# Merge the population data with divorce data
dfDivorce <- left_join(states_pop, divorce_plot, join_by("state")) %>%
  select(-fips, -full) %>%
  mutate(distrib = ((Freq/pop_2015)*100000)) %>%
  select(-Freq, -pop_2015)
# Plots the distribution of divorces in each state per population
plot_usmap(data = dfDivorce, values = "distrib", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = 
      "Divorce Related Questions per 100,000 people"
    , label = scales::comma) + 
  theme(legend.position = "bottom") +
  labs(title = "US map plot of distribution of divorce related questions")
```

# Visualization 3: Financial Status Correlation with Divorce Rate

```{r eval= TRUE, include=TRUE, echo=FALSE, warning = FALSE, message=FALSE}

# Visualization 3

# Get rid of outliers
quartiles <- quantile(data_overall$AnnualIncome, probs=c(.25, .75), na.rm = FALSE)
IQR <- IQR(data_overall$AnnualIncome)
Lower <- quartiles[1] - 1.5*IQR
Upper <- quartiles[2] + 1.5*IQR

# Investigating the correlation between 
data_noOutlier <- subset(data_overall, AnnualIncome > Lower & AnnualIncome < Upper)

#   Bar charts of median annual income level of people of various marital status
#   Faceted by subcategory 
ggplot(data = data_noOutlier, aes(x = AnnualIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = " AnnualIncome",
       y = "Divorce related Questions Mentioned",
       title = "Divorce related questions analysis with Client Annual Income and 
       Marital Status") +
  facet_wrap(~ Subcategory) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5))


#   Bar charts of median savings balance level of people of various marital status
#   Faceted by subcategory 
ggplot(data = data_noOutlier, aes(x = SavingsBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Savings Balance",
       y = "Divorce related Questions Mentioned",
       title = "Divorce related questions analysis with Client Savings Balance and 
       Marital Status") +
  facet_wrap(~ Subcategory) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5))


#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
ggplot(data = data_noOutlier, aes(x = CheckingBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = " Checking Balance",
       y = "Divorce related Questions Mentioned",
       title = "Divorce related questions analysis with Client Checking Balance and 
       Marital Status") +
  facet_wrap(~ Subcategory) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5))

#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
ggplot(data = data_noOutlier, aes(x = AllowedIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = " Allowed Income",
       y = "Divorce related Questions Mentioned",
       title = "Divorce related questions analysis with Client Allowed Income and 
       Marital Status") +
  facet_wrap(~ Subcategory) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5))
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used 
model1 <- glm(factor(Subcategory) ~ . -Category, data = data_overall, family = 'binomial')
summary(model1)
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Chisqtest 
chisq.test(data_overall$Subcategory, data_overall$SavingsBalance)
chisq.test(data_overall$Subcategory, data_overall$AnnualIncome)
chisq.test(data_overall$Subcategory, data_overall$CheckingBalance)
chisq.test(data_overall$Subcategory, data_overall$AllowedIncome)
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 2: Marital Status and Savings Balance influence on divorce related questions
model2 <- glm(Subcategory ~ factor(MaritalStatus) + SavingsBalance ,
              data = data_overall, family = 'binomial')
summary(model2)

par(mfrow = c(2, 2))
plot(model2)
vif(model2) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 2 Residuals  
model2 <- glm(Subcategory ~ factor(MaritalStatus) + SavingsBalance ,
              data = data_overall, family = 'binomial')
summary(model2)

vif(model2) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 3: 
model3 <- glm(factor(Subcategory) ~ SavingsBalance + CheckingBalance + 
              factor(MaritalStatus) + NumberInHousehold , data = data_overall,
              family = 'binomial')
summary(model3)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 4:
model4 <- glm(factor(Subcategory) ~ AllowedIncome, data = data_overall,
              family = 'binomial')
summary(model4)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 5: Are just the states good predictors?
model5 <- glm(factor(Subcategory) ~ factor(StateAbbr) , data = data_overall,
              family = 'binomial')
summary(model5)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model comparison
model_comparison <- compareGLM(model1, model2, model3, model4, model5)
```

```{r eval= TRUE, include=TRUE, echo=FALSE}
model_comparison[1]
model_comparison[2]
```


# Model Accuracy

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Accuracy Table
acc_table <- table(factor(data_overall$Subcategory), predict(model1)>0)
acc_table
```


```{r eval= TRUE, include=TRUE, echo=FALSE}
# % Accuracy
accuracy <- ((acc_table[1] + acc_table[4])/sum(acc_table))*100
print(paste0("The accuracy of our optimum model was: ", round(accuracy, 2), "%."))
```

# COMMENTS

Daniel: 
- It appears that our model 1 is the most accurate since it has the lowest AIC.
- I think we can only use 1 model for viz 2 and viz 3, otherwise our pdf page count is more than 8 pages.
- For viz 2, it might be better to look at the number of divorces per the population because as we'd expect, states with a large population would have more divorce related questions.

- Also a bit weird that state like California and Idaho don't have any divorce related questions. I think thats because when we filtered the subcategories, those states don't have any subcategories with "Divorce". I don't know how we'd account for that... but we might need to so Prince doesn't mark us off.

Daniel: 
- We might need to remove the StateAbbr "US"??? Billy: Prolly
- Actually we might not need to remove StateAbbr "US". Looking at the instructions PDF, is says that the "US" is a category for immigrants and veterans. So while its not a state in itself, still might be important to keep??

Comment by Billy:
- The AIC is alarmingly high
- Some assumptions to consider for our model
  - observations are independent
  - no severe multicollinearity among explanatory variables, no highly correlated
    variables
  - no extreme outliers
  - exist linear relationship between explanatory variable and logit of response
    linearly related to log odds
  - Large sample set
  - Remove outliers
  - Remove independent variables with collinealarity
  

Datasets: 
  - Statesites
    - StateAbbr
    - AllowedAssets
    - BaseIncomeLimit
    - PerHouseholdMemberIncomeLimit
    - IncomeMultiplier 
  - Client
    - StateAbbr
    - Prettymuch the entire dataset 
  - Categories
    - Category: Family and Children 
   -nSubcategories: everything related to divorces