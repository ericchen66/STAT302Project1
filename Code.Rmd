---
title: "Project 1 - Analysis of American Bar Association data"
author: "Eric Chen, Junhan Li, & Daniel Fredin"
output: pdf_document
---

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(splitstackshape)
library(readr)
library(car)
library(lmtest)
library(rcompanion)
library(olsrr)
library(maps)
library(usmap)
library(cowplot)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Load datasets
attorneys <- read.csv("attorneys.csv")
attorneys_time <- read.csv("attorneytimeentries.csv")
categories <- read.csv("categories.csv")
clients <- read.csv("clients.csv")
questionposts <- read.csv("questionposts.csv")
questions <- read.csv("questions.csv")
statesites <- read.csv("statesites.csv")
subcategories <- read.csv("subcategories.csv")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
## DATA CLEANING
# Remove unwanted columns for all datasets
attorneys <- attorneys %>%
  select(-Id, -CreatedUtc, -City, -PostalCode)
attorneys_time <- attorneys_time %>%
  select(-Id, -EnteredOnUtc, -TimeEntryUno)
categories <- categories %>%
  select(-Id)
clients <- clients %>%
  select(-Id, -PostalCode, -CreatedUtc, -InvestmentsBalance)
questionposts <- questionposts %>%
  select(-Id, -CreatedUtc)
questions <- questions %>%
  select(-Id, -AskedOnUtc, -TakenOnUtc, -ClosedOnUtc, -LegalDeadline, -ClosedByAttorneyUno)
statesites <- statesites %>%
  select(-Id)
subcategories <- subcategories %>%
  select(-Id)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Convert characters to numeric in client dataset
clients$Age <- as.integer(clients$Age)
clients$NumberInHousehold <- as.integer(clients$NumberInHousehold)
clients$AnnualIncome <- as.numeric(clients$AnnualIncome)
clients$AllowedIncome <- as.numeric(clients$AllowedIncome)
clients$CheckingBalance <- as.numeric(clients$CheckingBalance)
clients$SavingsBalance <- as.numeric(clients$SavingsBalance)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# rename columns to match other datasets
questions <- questions %>%
  rename("ClientUno" = "AskedByClientUno", "AttorneyUno" = "TakenByAttorneyUno")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Merge into two dataframes
# df1 is all datasets except attorney and attorney_time
df1 <- left_join(clients, questions, join_by("StateAbbr", "ClientUno")) %>% 
  left_join(., categories, join_by("StateAbbr", "CategoryUno", "Category")) %>%
  left_join(.,subcategories, join_by("StateAbbr", "CategoryUno", "Subcategory", "SubcategoryUno")) %>%
  left_join(., questionposts, join_by("StateAbbr", "QuestionUno")) %>%
  left_join(., statesites, join_by("StateAbbr", "StateName"))
# df2 is the two attorney datasets
df2 <- left_join(attorneys, attorneys_time, join_by("StateAbbr", "AttorneyUno")) 
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Select the independent variables we want to observe and Remove all NA
data_overall <- df1 %>%
  select(StateAbbr, Age, NumberInHousehold, MaritalStatus, AnnualIncome, SavingsBalance, CheckingBalance, AllowedIncome, Category, Subcategory, ClientUno) %>%
  distinct(ClientUno, .keep_all = TRUE) %>%
  select(-ClientUno) %>%
  na.omit(df1)
# Remove all NUll from the MaritalStatus variable 
data_overall <- data_overall %>%  filter(data_overall$MaritalStatus != "NULL")
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Change the subcategory to binary categorical data 
# Divorce mentioned entry is represented by 1, otherwise 0. 
data_overall$Subcategory <- ifelse(str_detect(data_overall$Subcategory, "Divorce"), 1, 0)
```


# Visualization 1: Investigating the Top 15 Subcategories of Asked Questions

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 1
top_subcats <- questions %>%
  group_by(Subcategory) %>%
  summarise(num_subcats = n()) %>%
  ungroup()
top_subcats <- top_subcats %>%
  arrange(desc(num_subcats)) %>%
  head(15)
ggplot(top_subcats, aes(x = num_subcats, y = reorder(Subcategory, num_subcats))) +
  geom_bar(stat = "Identity", fill = "#00A19B") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust = 0.5)) +
  labs(title = "Top 15 Subcategories",
       x = "Number of Clients",
       y = "Subcategory")
```
Interpretation:

  For our project, we want to started off with investigating the most frequently asked legal questions subcategories so we can define a most common question type based on the data set we have at hand and use it as the theme of our research question. 

  Based on our side way bar chart, it is clear to see that out of the top 15 subcategories, among the top three categories of questions asked by clients on the online platform, two of them are related to divorce.The question of subcategory Family/Divorce/Custody has the highest frequency among the top 15, and it has been asked by almost twice as many clients than the second subcategory of others, which is showing that the divorce related questions should be treated with more preparation when it comes to training volunteers.  

  This is intriguing to us as it begs for answers to the questions such as: "What are the major determinants of divorce?","Do the clients' backgrounds affect their tendency to ask divorce related question on the ABA online platform?", and most importantly, "How do we prepare our volunteers to address these divorce related questions?"
  

# Visualization 2: US Map of Divorce Related Questions Distribution

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ]  
# Plots the distribution of divorces in each state
div_map <- plot_usmap(data = divorce_plot, values = "Freq", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Number of Questions"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Number of divorce related questions")
```
  
```{r eval= TRUE, include=TRUE, echo=FALSE}
# Visualization 2
# Create a data set with divorce related questions frequency per state
contingency <- table(data_overall$StateAbbr,data_overall$Subcategory)
divorce_distrib <- as.data.frame(contingency)
# Change the column name var1 to state, so we can use plot_usmap
colnames(divorce_distrib)[which(names(divorce_distrib) == "Var1")] <- "state"
# Selects the number of divorces per state
divorce_plot <- divorce_distrib[divorce_distrib$Var2 != 0, ] 
# Changes state variable back to charcter
divorce_plot$state <- as.character(divorce_plot$state)
# Retrieve state populations and rename abbr column to state
states_pop <- statepop
states_pop <- states_pop %>%
  rename("state" = "abbr")
# Merge the population data with divorce data
dfDivorce <- left_join(states_pop, divorce_plot, join_by("state")) %>%
  select(-fips, -full) %>%
  mutate(distrib = ((Freq/pop_2015)*100000)) %>%
  select(-Freq, -pop_2015)
# Plots the distribution of divorces in each state per population
DF_map <- plot_usmap(data = dfDivorce, values = "distrib", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = 
      "Questions per 100,000 people"
    , label = scales::comma) + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) +
  labs(title = "Frequency of divorce related questions")

plot_grid(DF_map, div_map, ncol = 2, nrow = 1)
```
Interpretation:

  Certain States such as: Washington, Oregon, Nevada, Montana, Colorado, 
Minnesota, Ohio, and Kentucky are shown in gray because out of confidentiality 
and per state law, they are not allowed to provided clients' information, including the category of legal question they ask.

  For the 42 states that allow the disclosure of client information, Texas and Florida clearly have the highest number of divorce-related legal questions being asked. However, the distribution of the divorce question frequency does paints a different picture. Texas and Florida no longer stand out when we measure the number of questions asked per 100,000 residents. Here, the states of Wyoming and Maine stand out as places where divorce-related legal advice is most frequently sought on the online platform.

# Visualization 3: Financial Status Correlation with Divorce Rate

```{r eval= TRUE, include=TRUE, echo=FALSE, warning = FALSE, message=FALSE}

# Visualization 3

# Get rid of outliers
quartiles <- quantile(data_overall$AnnualIncome, probs=c(.25, .75), na.rm = FALSE)
IQR <- IQR(data_overall$AnnualIncome)
Lower <- quartiles[1] - 1.5*IQR
Upper <- quartiles[2] + 1.5*IQR

# Investigating the correlation between 
data_noOutlier <- subset(data_overall, AnnualIncome > Lower & AnnualIncome < Upper)

# Create facet titles
Subcategory.labs <- c("Divorce", "Other")
names(Subcategory.labs) <- c("1", "0")

#   Bar charts of median annual income level of people of various marital status
#   Faceted by subcategory 
PlotAnnual <- ggplot(data = data_noOutlier, aes(x = AnnualIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Annual Income",
       y = "Marital Status",
       title = "Client Marital Status and Annual Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median savings balance level of people of various marital status
#   Faceted by subcategory 
PlotSavings <- ggplot(data = data_noOutlier, aes(x = SavingsBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Savings Balance",
       y = "Marital Status",
       title = "Client Marital Status and Savings Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")


#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotCheckings <- ggplot(data = data_noOutlier, aes(x = CheckingBalance , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Checking Balance",
       y = "Marital Status",
       title = "Client Marital Status and Checking Balance, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

#   Bar charts of median checking balance level of people of various marital status
#   Faceted by subcategory 
PlotAllowed <- ggplot(data = data_noOutlier, aes(x = AllowedIncome , y = MaritalStatus, fill 
                                  = MaritalStatus)) +
  stat_summary(geom = "bar", fun.y = "median") +
  labs(x = "Allowed Income",
       y = "Marital Status",
       title = "Client Marital Status and Allowed Income, 
       Split by Divorce Related Questions/Other Questions") +
  facet_wrap(~ Subcategory, labeller = labeller(Subcategory = Subcategory.labs)) +
  theme_bw(base_size = 10) +
  theme(plot.title =
          element_text(hjust = 0.5), legend.position = "none")

plot_grid(PlotAnnual, PlotAllowed, ncol = 1, nrow = 2)
plot_grid(PlotCheckings, PlotSavings, ncol = 1, nrow = 2)
```
Interpretation: 
  
  From the above visualization, we can see that the annual income of clients asking divorce-related questions is higher on average compared to other clients. The exception is in the married/remarried category, which itself exhibits higher annual income than other marital statuses across both question categories. The states also recognize this discrepancy and generally allow higher income married individuals to ask pro bono questions. That is, the allowed income is noticeably higher for married or remarried people compared to other marital statuses. If someone wishes to ask a divorce-related question, we can also see that if they do not wish to disclose their marital status, their allowed income to ask a question free of charge drops. 
  
  Both the checking and savings balances of clients pursuing divorce-related advice is lower on average than the balances of clients asking other questions. Among all marital statuses asking divorce questions, divorced clients have the highest checking balance and widowed clients have the lowest. This is interesting because both statuses assume a person has no current partner. Clients with similar statuses, like single or separated, have average checking balances in between widowed and divorced clients. However, single and separated clients tend to not have high balances in their savings accounts, no matter what legal advice they are seeking. Unlike the data of annual/allowed income, married clients do not maintain significantly higher checking or savings balances compared to other clients, with the exception of the savings balance of clients asking non divorce-related legal questions.


# Research question: What variables are significant predictors of whether a legal question is related to divorce?

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used (in reference to FL and Single)
data_overall$StateAbbr <- relevel(factor(data_overall$StateAbbr), ref = 'FL')
data_overall$MaritalStatus <- relevel(factor(data_overall$MaritalStatus), ref = 'Single')

model1 <- glm(factor(Subcategory) ~ factor(StateAbbr) + Age + NumberInHousehold
              + factor(MaritalStatus) + AnnualIncome + SavingsBalance + CheckingBalance
              - AllowedIncome - Category, data = data_overall, family = 'binomial')
summary(model1)
```

### Checking for Multicollinearity

When conducting a test for multicollinearity we found that two of our independent variables were highly correlated, with GVIF values much greater than 5, and needed to be removed.

```{r eval= TRUE, include=TRUE, echo=FALSE}
vif(model1)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 1:All independent variables used 
model1 <- glm(factor(Subcategory) ~ . -Category - AllowedIncome, data = data_overall, family = 'binomial')
summary(model1)
```

### Fixing Multicollinearity

After removing the independent variable "AllowedIncome" we find that our multicollinearity is below 5 and therefore reflects the fact that there is an absence of multicollinearity in our model.

```{r eval= TRUE, include=TRUE, echo=FALSE}
vif(model1)
```


```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 2: Marital Status and Savings Balance influence on divorce related questions
model2 <- glm(Subcategory ~ factor(MaritalStatus) + SavingsBalance ,
              data = data_overall, family = 'binomial')
summary(model2)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 3: 
model3 <- glm(factor(Subcategory) ~ SavingsBalance + CheckingBalance + 
              factor(MaritalStatus) + NumberInHousehold , data = data_overall,
              family = 'binomial')
summary(model3)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 4:
model4 <- glm(factor(Subcategory) ~ AllowedIncome, data = data_overall,
              family = 'binomial')
summary(model4)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model 5: Are just the states good predictors?
model5 <- glm(factor(Subcategory) ~ factor(StateAbbr) , data = data_overall,
              family = 'binomial')
summary(model5)
```

```{r eval= TRUE, include=FALSE, echo=FALSE}
# Model comparison
model_comparison <- compareGLM(model1, model2, model3, model4, model5)
```

### Comparison of Models

```{r eval= TRUE, include=TRUE, echo=FALSE}
model_comparison[1]
model_comparison[2]
```


### Odds ratio and confidence intervals for the Best Model

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Using Standard Errors
exp(cbind(OR = coef(model1), confint.default(model1)))
```

### Accuracy of Best Model

```{r eval= TRUE, include=TRUE, echo=FALSE}
# Accuracy Table
acc_table <- table(factor(data_overall$Subcategory), predict(model1)>0)
acc_table
```

```{r eval= TRUE, include=TRUE, echo=FALSE}
# % Accuracy
accuracy <- ((acc_table[1] + acc_table[4])/sum(acc_table))*100
print(paste0("The accuracy of our best model was: ", round(accuracy, 2), "%."))
```

# COMMENTS


WHAT WE NEED TO FINISH:

- Explain our assumptions (ie. multicollinearity)
- Explain what we intend to achieve with proposed question
- Comment on our findings related to the research question
- clearly state our dependent and independent variables
- Explain why we selected the best model (using lowest AIC, BIC )
- Explain our log odds
- Explain Confidence interval   
- Discuss the positive predictor and negative predictor variables (in reference to FL and Single)
- Suggestion based on limitations , missing data = limitation, states didn't provide data, also some states didn't have Divorce as a subcategory (such as California and the states that are white in viz 2)
- Ask whether visualizations meet the requirements (maybe need to change viz 1 to something different.)

- SIGN THE FORM SO WE'RE GRADED!!!
   

   
   

  